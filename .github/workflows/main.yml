name: Build OpenWrt for K2 (128M+32M+Custom)

on:
  watch:
    types: [started] # 点击仓库 Star 触发
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3

      - name: Clone source code
        run: |
          git clone --depth 1 -b openwrt-23.05 https://github.com/openwrt/openwrt.git

      - name: Patch for 128M RAM & 32M Flash
        run: |
          cd openwrt
          DTS_FILE="target/linux/ramips/dts/mt7620a_phicomm_k2-v22.4.dts"
          
          # 1. 修改内存为 128M
          sed -i 's/<0x0 0x4000000>/<0x0 0x8000000>/g' $DTS_FILE
          
          # 2. 修改 Flash 分区表 (32M 布局)
          # firmware 扩容至 0x1fa0000 (约 31.6MB)
          sed -i 's/reg = <0x50000 0x7b0000>/reg = <0x50000 0x1fa0000>/g' $DTS_FILE
          # art (EEPROM) 挪到 32M 末尾 (0x1ff0000)
          sed -i 's/reg = <0x7f0000 0x10000>/reg = <0x1ff0000 0x10000>/g' $DTS_FILE
          
          echo "DTS patch applied."

      - name: Update & Install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Custom Configuration
        run: |
          cd openwrt
          # 设定目标硬件
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7620=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7620_DEVICE_phicomm_k2-v22.4=y" >> .config
          
          # 预装 LuCI、中文语言包及常用基础组件
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y" >> .config
          
          make defconfig

      - name: Create Custom Files (WiFi, Password, Source)
        run: |
          cd openwrt
          mkdir -p files/etc/uci-defaults
          
          # 1. 预设 root 密码为 root
          NEW_PASS=$(openssl passwd -1 "root")
          sed -i "s|root:[^:]*:|root:${NEW_PASS}:|" package/base-files/files/etc/shadow

          # 2. 编写初始化脚本
          cat <<EOF > files/etc/uci-defaults/99-custom-settings
          # 设置时区与语言
          uci set system.@system[0].zonename='Asia/Shanghai'
          uci set system.@system[0].timezone='CST-8'
          uci set luci.main.lang='zh_cn'

          # 配置 2.4G WiFi (MiWIFI / 12345678)
          uci set wireless.default_radio0.ssid='MiWIFI'
          uci set wireless.default_radio0.encryption='psk2'
          uci set wireless.default_radio0.key='12345678'
          uci set wireless.radio0.disabled='0'

          # 配置 5G WiFi (MiWIFI_5G / 12345678)
          uci set wireless.default_radio1.ssid='MiWIFI_5G'
          uci set wireless.default_radio1.encryption='psk2'
          uci set wireless.default_radio1.key='12345678'
          uci set wireless.radio1.disabled='0'

          # 软件源一键替换为阿里云镜像
          sed -i 's/downloads.openwrt.org/mirrors.aliyun.com\/openwrt/g' /etc/opkg/distfeeds.conf

          uci commit
          EOF
          
          chmod +x files/etc/uci-defaults/99-custom-settings

      - name: Download package
        run: cd openwrt && make download -j8

      - name: Compile the firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: K2-HardMod-32M-128M
          path: openwrt/bin/targets/ramips/mt7620/*.bin
